/**********************************************************************************************************************************************************
 * ActivateByProximity
 * -------------------
 *
 * 2021-09-26
 *
 * Sends an event when the camera comes close.
 *
 * Roy Davies, Smart Digital Lab, University of Auckland.
 **********************************************************************************************************************************************************/
 
using System.Collections;
using System.Collections.Generic;
using UnityEngine;


// ----------------------------------------------------------------------------------------------------------------------------------------------------------
// Public functions
// ----------------------------------------------------------------------------------------------------------------------------------------------------------
public interface _ActivateByProximity
{
    void Input(XRData newData);
}
// ----------------------------------------------------------------------------------------------------------------------------------------------------------



// ----------------------------------------------------------------------------------------------------------------------------------------------------------
// Main class
// ----------------------------------------------------------------------------------------------------------------------------------------------------------
[AddComponentMenu("OpenXR UX/Tools/Activate By Proximity")]
public class ActivateByProximity : MonoBehaviour, _ActivateByProximity
{
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    // Public variables
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    [Header("____________________________________________________________________________________________________")]
    [Header("Send an event when nearby.\n____________________________________________________________________________________________________")]
    [Header("INPUTS\n\n - Input() - Set up the XRData to send when nearby.")]

    [Header("____________________________________________________________________________________________________")]
    [Header("SETTINGS")]
    [Header("Distance to activate at.")]
    public float distance = 2.0f;                       // Proximity to activate at

    [Header("Event and Action to send when activated")]
    public XRDeviceEventTypes activateTrigger;          // Event to send when activating
    public XRDeviceActions activateAction;              // Action to send when activating

    [Header("____________________________________________________________________________________________________")]
    [Header("OUTPUTS")]
    // ------------------------------------------------------------------------------------------------------------------------------------------------------



    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    // Private variables
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    private XRDeviceManager watcher;                    // The XR Event Manager
    private bool triggered = false;                     // Whether triggered or not
    private XRData data;                                // The data to send
    // ------------------------------------------------------------------------------------------------------------------------------------------------------



    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    // Get access to the main event queue
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    void Start()
    {
        // Find the object that has the event manager on it.  It should be the only one with tag XREvents.
        GameObject watcherGameObject = GameObject.FindWithTag("XREvents");
        if (watcherGameObject == null)
            Debug.Log("No XR Device Manager in SceneGraph that is tagged XREvents");
        else
        {
            // Get the script
            watcher = watcherGameObject.GetComponent<XRDeviceManager>();
        }
    }
    // ------------------------------------------------------------------------------------------------------------------------------------------------------



    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    // Set the input data
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    public void Input(XRData newData)
    {
        data = newData;
    }
    // ------------------------------------------------------------------------------------------------------------------------------------------------------



    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    // Watch the event queue and send 
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
    void Update()
    {
        if (Camera.main != null)
        {
            if ((Vector3.Distance(Camera.main.transform.position, this.transform.position) <= distance) && !triggered)
            {
                triggered = true;

                XREvent eventToSend = new XREvent();
                eventToSend.eventType = activateTrigger;
                eventToSend.eventAction = activateAction;
                eventToSend.data = data;

                watcher.XREventQueue.Invoke(eventToSend);
            } 
            else if ((Vector3.Distance(Camera.main.transform.position, this.transform.position) > distance) && triggered)
            {
                triggered = false;     
            }
        }
    }
    // ------------------------------------------------------------------------------------------------------------------------------------------------------
}
